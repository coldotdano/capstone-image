<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Instruction Image Generator</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-top: 0;
        }

        .controls,
        .exercise-selector {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #4CAF50;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-download {
            background: #2196F3;
        }

        .btn-download:hover {
            background: #0b7dda;
        }

        .btn-clear {
            background: #ff9800;
        }

        .btn-clear:hover {
            background: #e68900;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .exercise-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .exercise-card h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 6px;
            font-size: 16px;
        }

        .image-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .image-container img {
            width: 31%;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .instruction {
            font-size: 12px;
            color: #555;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            flex: 1;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: center;
            min-width: 160px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .exercise-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .exercise-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .exercise-item:hover {
            background: #f8f9fa;
        }

        .exercise-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
        }

        .exercise-item.generated {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }

        .exercise-item.generated::after {
            content: "‚úì Generated";
            color: #4CAF50;
            font-weight: bold;
            font-size: 11px;
            margin-left: 6px;
        }

        .exercise-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .exercise-meta {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
            line-height: 1.3;
        }

        .selection-summary {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 13px;
            display: none;
        }

        .toggle-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 13px;
        }

        input[type=file] {
            margin-top: 10px;
        }

        .small-note {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .badge-mode {
            background: #2E8BFF;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <h1>üèãÔ∏è Exercise Instruction Image Generator</h1>

    <div class="controls">
        <div style="display:flex; justify-content:space-between; flex-wrap:wrap;">
            <div>
                <label style="margin-right:20px;">
                    <input type="checkbox" id="testModeToggle" checked>
                    <strong>Test Mode</strong> (placeholder images, no credits used)
                </label>
                <label style="margin-right:20px;">
                    <input type="checkbox" id="useEmbeddedPromptsToggle">
                    Use embedded prompts (from JSON)
                </label>
                <label style="margin-right:20px;">
                    <input type="checkbox" id="omitLabelsToggle">
                    Omit badge & phase label (for clean images)
                </label>
            </div>
            <button onclick="logoutPuter()" class="btn-danger">Logout from Puter</button>
        </div>
        <div class="toggle-row">
            <div>
                <input type="file" id="localJsonInput" accept=".json">
                <div class="small-note">Load your generated JSON (object with "exercises").</div>
            </div>
            <div>
                <button id="loadLocalBtn">Load Local JSON</button>
                <button id="loadRemoteBtn">Load Remote Default</button>
            </div>
        </div>
        <div id="status" class="info">Ready. Load JSON to begin.</div>
    </div>

    <div class="exercise-selector">
        <h2>Select Exercises to Generate</h2>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Exercises</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="selectedCount">0</div>
                <div class="stat-label">Selected</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="generatedCount">0</div>
                <div class="stat-label">Already Generated</div>
            </div>
        </div>

        <input type="text" id="searchBox" class="search-box"
            placeholder="Search by name, category, equipment, or muscle...">

        <div class="selection-summary" id="selectionSummary">
            <strong>Selected:</strong> <span id="selectedList"></span>
        </div>

        <div class="exercise-list" id="exerciseList">
            <div class="loading">Load a JSON file above...</div>
        </div>

        <div style="margin-top:15px;">
            <button onclick="selectAll()">Select All Visible</button>
            <button onclick="clearSelection()" class="btn-clear">Clear Selection</button>
            <button id="generateBtn" onclick="generateSelectedImages()" disabled>Generate Selected Images</button>
            <button id="downloadBtn" onclick="downloadJSON()" disabled>Download Generated Metadata JSON</button>
            <button id="downloadImagesBtn" class="btn-download" onclick="downloadAllImages()" disabled>Download All
                Images</button>
            <button onclick="showResetModal()" class="btn-danger">Clear Generated Data</button>
        </div>
    </div>

    <div id="exerciseContainer" class="exercise-grid"></div>

    <!-- Reset Modal -->
    <div id="resetModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1000;">
        <div style="background:#fff; max-width:420px; margin:10% auto; padding:20px; border-radius:8px;">
            <h3>Clear Generated Data?</h3>
            <p>This removes tracking of previously generated images (localStorage). Images already downloaded are
                unaffected.</p>
            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeResetModal()" class="btn-clear">Cancel</button>
                <button onclick="resetGeneratedData()" class="btn-danger">Clear Data</button>
            </div>
        </div>
    </div>

    <script>
        const REMOTE_URL = "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/dist/exercises.json";

        let rawExercises = [];
        let exercises = [];
        let generatedExercises = [];
        let generatedExerciseIds = new Set();
        let selectedExercises = new Set();
        let filteredExercises = [];

        // DOM refs
        const statusEl = document.getElementById('status');
        const exerciseListEl = document.getElementById('exerciseList');
        const searchBoxEl = document.getElementById('searchBox');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadImagesBtn = document.getElementById('downloadImagesBtn');
        const localJsonInput = document.getElementById('localJsonInput');
        const loadLocalBtn = document.getElementById('loadLocalBtn');
        const loadRemoteBtn = document.getElementById('loadRemoteBtn');
        const useEmbeddedPromptsToggle = document.getElementById('useEmbeddedPromptsToggle');
        const omitLabelsToggle = document.getElementById('omitLabelsToggle');

        function showStatus(msg, type = 'info') {
            statusEl.textContent = msg;
            statusEl.className = type;
        }

        function loadGeneratedExercises() {
            const saved = localStorage.getItem('generatedExercises');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    generatedExercises = data.exercises || [];
                    generatedExerciseIds = new Set(data.ids || []);
                } catch (e) {
                    console.warn('Failed to parse saved generated exercises', e);
                }
            }
        }

        function saveGeneratedExercises() {
            const data = {
                exercises: generatedExercises,
                ids: Array.from(generatedExerciseIds)
            };
            localStorage.setItem('generatedExercises', JSON.stringify(data));
        }

        function resetGeneratedData() {
            localStorage.removeItem('generatedExercises');
            generatedExercises = [];
            generatedExerciseIds.clear();
            document.getElementById('exerciseContainer').innerHTML = '';
            downloadBtn.disabled = true;
            downloadImagesBtn.disabled = true;
            updateStats();
            renderExerciseList();
            closeResetModal();
            showStatus('Generated data cleared.', 'success');
        }

        function showResetModal() {
            document.getElementById('resetModal').style.display = 'block';
        }
        function closeResetModal() {
            document.getElementById('resetModal').style.display = 'none';
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = exercises.length;
            document.getElementById('selectedCount').textContent = selectedExercises.size;
            document.getElementById('generatedCount').textContent = generatedExerciseIds.size;
        }

        function updateSelectionSummary() {
            const summary = document.getElementById('selectionSummary');
            const list = document.getElementById('selectedList');
            if (selectedExercises.size > 0) {
                summary.style.display = 'block';
                const names = Array.from(selectedExercises).map(id => exercises.find(e => e.id === id)?.name).filter(Boolean).join(', ');
                list.textContent = names;
            } else {
                summary.style.display = 'none';
            }
            generateBtn.disabled = selectedExercises.size === 0;
        }

        function normalizeLoadedData(data) {
            // Accept either array or object with "exercises"
            if (Array.isArray(data)) return data;
            if (data && Array.isArray(data.exercises)) return data.exercises;
            throw new Error('Loaded JSON is not an array and does not have an "exercises" property that is an array.');
        }

        function assignIds(list) {
            return list.map((ex, idx) => ({
                ...ex,
                id: ex.id || `${(ex.name || 'exercise').toLowerCase().replace(/[^a-z0-9]+/g, '_')}_${idx}`
            }));
        }

        function renderExerciseList() {
            if (filteredExercises.length === 0) {
                exerciseListEl.innerHTML = '<div class="loading">No exercises match your search.</div>';
                return;
            }
            exerciseListEl.innerHTML = filteredExercises.map(ex => {
                const selected = selectedExercises.has(ex.id);
                const generated = generatedExerciseIds.has(ex.id);
                const classes = ['exercise-item'];
                if (selected) classes.push('selected');
                if (generated) classes.push('generated');
                return `
                    <div class="${classes.join(' ')}" onclick="toggleExercise('${ex.id}')">
                        <div style="flex:1;">
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-meta">
                                ${(ex.category || 'category?')} ‚Ä¢ ${(ex.equipment || 'equipment?')}<br>
                                ${(ex.primaryMuscles && ex.primaryMuscles.length) ? ex.primaryMuscles.join(', ') : 'muscles?'}
                            </div>
                        </div>
                        ${ex.prompts && ex.prompts.length ? '<span class="badge-mode">prompts</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        window.toggleExercise = function (id) {
            if (selectedExercises.has(id)) selectedExercises.delete(id);
            else selectedExercises.add(id);
            renderExerciseList();
            updateSelectionSummary();
        };

        function selectAll() {
            filteredExercises.forEach(ex => selectedExercises.add(ex.id));
            renderExerciseList();
            updateSelectionSummary();
        }

        function clearSelection() {
            selectedExercises.clear();
            renderExerciseList();
            updateSelectionSummary();
        }

        searchBoxEl.addEventListener('input', () => {
            const q = searchBoxEl.value.toLowerCase().trim();
            if (!q) {
                filteredExercises = [...exercises];
            } else {
                filteredExercises = exercises.filter(ex => {
                    const haystack = [
                        ex.name,
                        ex.category,
                        ex.equipment,
                        ...(ex.primaryMuscles || []),
                        ...(ex.secondaryMuscles || [])
                    ].filter(Boolean).join(' ').toLowerCase();
                    return haystack.includes(q);
                });
            }
            renderExerciseList();
        });

        async function loadRemote() {
            try {
                showStatus('Loading remote exercises...', 'info');
                const resp = await fetch(REMOTE_URL);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                rawExercises = normalizeLoadedData(data);
                exercises = assignIds(rawExercises);
                filteredExercises = [...exercises];
                renderExerciseList();
                updateStats();
                showStatus(`Loaded ${exercises.length} exercises from remote source.`, 'success');
            } catch (e) {
                showStatus('Error loading remote: ' + e.message, 'error');
            }
        }

        async function loadLocal() {
            const file = localJsonInput.files?.[0];
            if (!file) {
                showStatus('Select a local JSON file first.', 'warning');
                return;
            }
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                rawExercises = normalizeLoadedData(json);
                exercises = assignIds(rawExercises);
                filteredExercises = [...exercises];
                renderExerciseList();
                updateStats();
                showStatus(`Loaded ${exercises.length} exercises from local file.`, 'success');
            } catch (e) {
                showStatus('Local file error: ' + e.message, 'error');
            }
        }

        loadLocalBtn.addEventListener('click', loadLocal);
        loadRemoteBtn.addEventListener('click', loadRemote);

        // Fallback dynamic phase descriptions (if not using embedded prompts)
        function generatePhaseDescriptions(exercise) {
            const instructions = exercise.instructions || [];
            return [
                {
                    step: 1,
                    phase: "Starting Position",
                    description: instructions[0] || `starting position for ${exercise.name}`,
                    arrowDescription: "no movement arrows"
                },
                {
                    step: 2,
                    phase: "Execution Phase",
                    description: instructions[1] || instructions[0] || `performing the main movement of ${exercise.name}`,
                    arrowDescription: "Add a bright red arrow showing the primary direction of movement"
                },
                {
                    step: 3,
                    phase: "Return/Peak Phase",
                    description: instructions[2] || instructions[instructions.length - 1] || `completing the movement or returning`,
                    arrowDescription: "Add a bright red arrow showing the return movement direction"
                }
            ];
        }

        async function generateSelectedImages() {
            if (selectedExercises.size === 0) {
                showStatus('Select exercises first.', 'warning');
                return;
            }

            const btn = generateBtn;
            btn.disabled = true;

            const testMode = document.getElementById('testModeToggle').checked;
            if (!testMode) {
                try {
                    const signedIn = await puter.auth.isSignedIn();
                    if (!signedIn) {
                        showStatus('Sign in required for real images.', 'warning');
                        await puter.auth.signIn();
                    }
                } catch (e) {
                    showStatus('Auth failed: ' + e.message, 'error');
                    btn.disabled = false;
                    return;
                }
            }

            const list = Array.from(selectedExercises).map(id => exercises.find(e => e.id === id)).filter(Boolean);
            showStatus(`Generating images for ${list.length} exercise(s)...`, 'info');

            for (let i = 0; i < list.length; i++) {
                const ex = list[i];
                if (generatedExerciseIds.has(ex.id)) {
                    showStatus(`Skipping ${ex.name} (already generated).`, 'info');
                    continue;
                }
                await generateExerciseImages(ex);
            }

            showStatus('Generation completed.', 'success');
            downloadBtn.disabled = generatedExercises.length === 0;
            downloadImagesBtn.disabled = generatedExercises.length === 0;
            btn.disabled = false;
            clearSelection();
            updateStats();
            renderExerciseList();
        }

        async function generateExerciseImages(exercise) {
            const container = document.getElementById('exerciseContainer');
            const card = document.createElement('div');
            card.className = 'exercise-card';
            card.id = `ex-${exercise.id}`;
            card.innerHTML = `<h3>${exercise.name}</h3><div class="loading">Generating images...</div>`;
            container.appendChild(card);

            try {
                const useEmbedded = useEmbeddedPromptsToggle.checked && Array.isArray(exercise.prompts) && exercise.prompts.length;
                const omitLabels = omitLabelsToggle.checked;

                let phases;
                if (useEmbedded) {
                    // Use prompt objects from JSON
                    phases = exercise.prompts.slice(0, 3).map(p => ({
                        step: p.phase_number || p.phase || 1,
                        phase: p.phase_name || 'Phase',
                        customPrompt: p.prompt
                    }));
                } else {
                    // Build dynamic fallback
                    phases = generatePhaseDescriptions(exercise);
                }

                const images = [];
                const exerciseData = { ...exercise, instruction_images: [] };
                for (const phase of phases) {
                    let prompt;
                    if (useEmbedded && phase.customPrompt) {
                        // Optionally strip badges/labels if omitLabels is checked
                        prompt = omitLabels
                            ? phase.customPrompt
                                .replace(/Include a bright blue.*?(label.*?")/gi, '')
                                .replace(/Include a bright blue.*?(sans-serif\.)/gi, '')
                                .replace(/blue \(#2E8BFF\).*?below\./gi, '')
                                .replace(/circular badge.*?below\./gi, '')
                                .replace(/badge.*?below\./gi, '')
                                .replace(/\s{2,}/g, ' ')
                            : phase.customPrompt;
                    } else {
                        // Dynamic prompt
                        prompt = `Minimalist black vector silhouette of a person performing ${exercise.name}, strict side view. Body position: ${phase.description}. ${phase.arrowDescription !== "no movement arrows" ? phase.arrowDescription + "." : ""} White background, flat solid fill${omitLabels ? ", no text, no numbers, no labels" : ""}. Professional fitness instruction diagram style.`;
                    }

                    const safeName = exercise.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const filename = `${safeName}-${phase.step}.png`;

                    showStatus(`Generating ${exercise.name} phase ${phase.step}...`, 'info');
                    let image;
                    try {
                        image = await puter.ai.txt2img(prompt, document.getElementById('testModeToggle').checked);
                        image.setAttribute('data-filename', filename);
                        images.push({ element: image, filename });
                        exerciseData.instruction_images.push(`images/${filename}`);
                    } catch (err) {
                        throw new Error(`Image generation failed: ${err.message || err}`);
                    }
                    await new Promise(r => setTimeout(r, 1200));
                }

                card.innerHTML = `
                    <h3>${exercise.name}</h3>
                    <div class="image-container">
                        ${images.map((imgObj, i) => `<img src="${imgObj.element.src}" alt="Phase ${i + 1}" data-filename="${imgObj.filename}">`).join('')}
                    </div>
                    <div class="instruction">
                        <strong>Instructions:</strong><br>
                        ${(exercise.instructions || []).map((t, i) => `${i + 1}. ${t}`).join('<br>')}
                    </div>
                `;

                generatedExercises.push(exerciseData);
                generatedExerciseIds.add(exercise.id);
                saveGeneratedExercises();
            } catch (e) {
                card.querySelector('.loading').textContent = '‚ùå ' + e.message;
                showStatus(`Error generating ${exercise.name}: ${e.message}`, 'error');
            }
        }

        async function downloadAllImages() {
            showStatus('Preparing downloads...', 'info');
            const imgs = document.querySelectorAll('.image-container img');
            for (let img of imgs) {
                const fn = img.getAttribute('data-filename');
                if (!fn) continue;
                try {
                    const resp = await fetch(img.src);
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fn;
                    a.click();
                    URL.revokeObjectURL(url);
                    await new Promise(r => setTimeout(r, 250));
                } catch (e) {
                    console.warn('Failed download', fn, e);
                }
            }
            showStatus('Image downloads triggered.', 'success');
        }

        function downloadJSON() {
            const dataStr = JSON.stringify(generatedExercises, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'generated_exercises_metadata.json';
            a.click();
            URL.revokeObjectURL(url);
            showStatus('Generated metadata JSON downloaded.', 'success');
        }

        async function logoutPuter() {
            try {
                await puter.auth.signOut();
                showStatus('Logged out. Refresh page to re-auth.', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch (e) {
                showStatus('Logout failed: ' + e.message, 'error');
            }
        }

        // Initialize stored data
        loadGeneratedExercises();
        updateStats();
    </script>
</body>

</html>